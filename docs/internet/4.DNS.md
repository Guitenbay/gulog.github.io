# DNS

域名系统（DNS）是互联网的电话簿。人类通过域名在线访问信息，如 `nytimes.com` 或 `espn.com`。网页浏览器通过互联网协议（IP）地址进行交互。DNS将域名转换为IP地址，以便浏览器可以加载互联网资源。

DNS解析过程涉及将主机名（如www.example.com）转换为计算机友好的IP地址（如192.168.1.1）。互联网上的每个设备都有一个IP地址。当用户想要加载网页时，必须在用户输入的网页浏览器（example.com）和定位 example.com 网页所需的机器友好地址之间进行翻译。

## 加载网页涉及4个DNS服务器：

1. 递归 DNS 解析器(DNS recursor) - recursor可以被认为是一个图书馆员，被要求去图书馆的某个地方寻找一本特定的书。DNS recursor是一种服务器，旨在通过网络浏览器等应用程序接收来自客户端机器的查询。
    > 通常，递归解析器负责提出额外的请求，以满足客户端的DNS查询。

2. 根域名服务器 - 根服务器是将（解析）人类可读主机名转换为IP地址的第一步。它可以被认为是图书馆中指向不同书架的索引——通常它作为对其他更具体位置的参考。

3. TLD域名服务器 - 顶级域服务器（TLD）可以被认为是图书馆中的特定书籍架。此域名服务器是搜索特定 IP 地址的下一步，它托管主机名的最后一部分（在 example.com 中，TLD服务器是 “com”）。

4. 权威域名服务器 - 这个最终的域名服务器可以被认为是书架上的字典，其中特定域名可以翻译成其定义。权威域名服务器是域名服务器查询的最后一站。如果权威域名服务器可以访问请求的记录，它将会把请求的主机名的 IP 地址返回给提出初始请求的 DNS Recursor（图书馆员）。

## 权威域名服务器和递归 DNS 解析器有什么区别？

递归解析器位于 DNS 查询的开头，权威域名服务器位于结尾。

## DNS 查找的步骤

> 注意：通常，DNS查找信息将本地缓存在查询计算机中或远程缓存在DNS基础设施中。DNS查找通常有8个步骤。当DNS信息被缓存时，从DNS查找过程中跳过步骤，从而使其更快。

下面的示例概述了当没有缓存任何东西时的所有 8 个步骤。

1. 用户在 Web 浏览器中键入“example.com”，查询进入互联网，并由DNS递归解析器接收。
2. 然后，解析器查询DNS根域名服务器（.）。
3. 然后，根服务器使用顶级域（TLD）DNS服务器（如.com或.net）的地址响应解析器，该服务器存储其域的信息。搜索example.com时，我们的请求指向.com顶级域名。
4. 然后，解析器向.com TLD发出请求。
5. 然后，TLD服务器响应返回域名服务器 example.com 的 IP 地址。
6. 然后，递归解析器向域名服务器发送查询。
7. 然后，example.com 的 IP 地址从域名服务器返回到解析器。
8. 然后，DNS 解析器将这个 IP 地址响应 Web 浏览器。

一旦DNS查找的8个步骤返回了 example.com 的IP地址，浏览器就可以对网页提出请求：

1. 浏览器向 IP 地址发出 HTTP 请求。
2. 该 IP 的服务器返回要渲染在浏览器中的网页。

## DNS查询的类型是什么？

在典型的DNS查找中，会出现三种类型的查询。通过使用这些查询的**组合**，优化的DNS解析过程可以减少数据传输距离。在理想情况下，缓存的记录数据将可用，允许DNS名称服务器返回非递归查询。

1. 递归查询 - 在递归查询中，DNS 客户端要求 DNS 服务器（通常是Web浏览器要求 DNS递归解析器）在解析器找不到记录时以请求的资源记录或错误消息响应客户端。
2. 迭代查询 - 在这种情况下，DNS 客户端将允许 DNS 服务器返回最佳答案。如果查询的DNS服务器与查询名称不匹配，它将返回对较低级别域名空间的DNS服务器的引用。（比如递归解析器请求根域名服务器、TLD服务器）然后，DNS客户端将对推荐地址进行查询。此过程继续在查询链下运行其他DNS服务器，直到发生错误或超时。
3. 非递归查询 - 通常，当DNS解析器客户端向 DNS 服务器查询其可以访问的记录时，会发生这种情况，因为它对记录具有权威性，或者该记录存在于其缓存中（比如递归解析器请求权威域名服务器）。通常，DNS服务器将缓存DNS记录，以防止额外的带宽消耗和上游服务器的负载。

## 什么是 DNS 缓存？DNS缓存发生在哪里？

缓存的目的是将数据暂时存储在一个位置，从而提高数据请求的性能和可靠性。
DNS缓存涉及将数据存储在更靠近请求客户端的地方，以便可以更早地解决DNS查询，并避免在DNS查找链下进一步查询，从而缩短加载时间并减少带宽/CPU消耗。
DNS数据可以**缓存在各种位置**，每个位置都将在由生存时间（TTL）确定的设定时间内存储DNS记录。

1. 浏览器DNS缓存：当请求DNS记录时，浏览器缓存是检查请求记录的第一个位置。
2. 操作系统（OS）级DNS缓存：操作系统级DNS解析器是DNS查询离开机器之前的第二个也是最后一个本地站点。操作系统内部旨在处理此查询的进程通常称为“存根解析器”或DNS客户端。当存根解析器收到来自应用程序的请求时，它首先检查自己的缓存，看看它是否有记录。如果没有，它将在本地网络之外向互联网服务提供商（ISP）内的DNS递归解析器发送DNS查询（具有递归标志集）。

## Reference
[1] https://www.cloudflare.com/en-gb/learning/dns/what-is-dns/
